<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aspen Ward ‚Äì Sunday Worship</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/dist/output.css">
</head>
<body>
<div class="news-flash" id="news-flash" role="alert" aria-live="polite" hidden>
  <div class="news-flash-content" id="news-flash-content"></div>
  <button class="news-flash-close" id="news-flash-close" type="button" aria-label="Close news flash">
    <span class="news-flash-close-icon"></span>
  </button>
</div>
<div class="app-shell">
<header class="site-header" aria-label="Primary navigation">
<div class="header-shell">
<a class="brand" href="#top">
<span class="brand-icon" aria-hidden="true">AW</span>
<span class="brand-copy">
<span class="brand-title" id="brand-title">Aspen Ward</span>
<span class="brand-subtitle" id="brand-subtitle">Sunday Worship &amp; Community</span>
</span>
</a>
<div class="header-actions">
<button class="theme-toggle" id="theme-toggle" type="button" aria-label="Switch to light theme" aria-pressed="false">
<span class="theme-icon" id="theme-icon" aria-hidden="true"></span>
</button>
<button class="menu-toggle" id="menu-toggle" type="button" aria-label="Toggle navigation" aria-controls="primary-nav" aria-expanded="false">
<span class="menu-lines"></span>
</button>
</div>
<nav class="primary-nav" id="primary-nav" aria-label="Section links">
<ul class="nav-list">
<li><a class="nav-link" data-scroll="program" href="#program">Program</a></li>
<li><a class="nav-link" data-scroll="announcements" href="#announcements" hidden>Announcements</a></li>
<li><a class="nav-link" data-scroll="events" href="#events">Events</a></li>
<li><a class="nav-link" href="/missionary">Missionary</a></li>
<li><a class="nav-link" href="/zoom">Zoom</a></li>
</ul>
</nav>
</div>
</header>
<main id="top">
<section class="hero" id="hero" aria-labelledby="hero-heading">
<div class="hero-shell">
<div class="hero-card">
<span class="hero-badge">This Sunday</span>
<h1 class="hero-title" id="hero-heading">Aspen Ward</h1>
<p class="hero-subtitle" id="hero-subtitle"></p>
<p class="hero-meta" id="hero-meta" role="status" aria-live="polite">üóìÔ∏è Gathering details loading‚Ä¶</p>
<div class="hero-actions">
<a class="btn" id="program-scroll" href="#program">Open the program</a>
<a class="btn ghost" id="events-scroll" href="#events">Ward events</a>
</div>
</div>
</div>
</section>
<section class="section" id="program" aria-labelledby="program-heading">
<div class="section-shell">
<div class="section-header">
<span class="section-overline">Sacrament outline</span>
<h2 class="section-title" id="program-heading">Sunday program</h2>
<p class="section-intro" id="program-intro"></p>
</div>
<div class="program-grid" id="program-grid" role="list"></div>
</div>
</section>
<section class="section simple" id="announcements" aria-labelledby="announcements-heading" hidden>
<div class="section-shell">
<div class="section-header">
<span class="section-overline">Quick updates</span>
<h2 class="section-title" id="announcements-heading">Ward announcements</h2>
<p class="section-intro">Ward reminders.</p>
</div>
<div class="announcements-list" id="announcements-list" role="list"></div>
</div>
</section>
<section class="section" id="events" aria-labelledby="events-heading">
<div class="section-shell">
<div class="section-header">
<span class="section-overline">Stay connected</span>
<h2 class="section-title" id="events-heading">Upcoming events</h2>
<p class="section-intro">Ward activities, service opportunities, and upcoming events.</p>
</div>
<div class="events-timeline" id="events-timeline" role="list"></div>
</div>
</section>
</main>
<footer class="site-footer" aria-label="Site footer">
<p id="footer-copy">‚ùñ Not an official site of The Church of Jesus Christ of Latter-day Saints. Intended for local Aspen Ward use only.</p>
<p class="footer-note">Designed by Aspen Ward members. <a href="/admin" style="color: var(--ink-muted); text-decoration: none;">¬∑</a></p>
</footer>
</div>
<div class="modal" id="banner-modal" role="dialog" aria-modal="true" aria-labelledby="banner-title" aria-describedby="banner-body" hidden>
<div class="modal-card">
<div class="modal-header">
<h2 class="modal-title" id="banner-title">Announcements</h2>
<button class="modal-close" id="modal-close" type="button" aria-label="Close banner"></button>
</div>
<div class="modal-body" id="banner-body"></div>
<button class="btn full" id="modal-dismiss" type="button">Got it!</button>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

// Firebase config (same as admin and missionary pages)
const firebaseConfig = {
  apiKey: "AIzaSyBbwlTuMoSMl2vfXA5aHkQM0RC2PUrKDXk",
  authDomain: "aspen-ward-missionary-dinner.firebaseapp.com",
  databaseURL: "https://aspen-ward-missionary-dinner-default-rtdb.firebaseio.com",
  projectId: "aspen-ward-missionary-dinner",
  storageBucket: "aspen-ward-missionary-dinner.firebasestorage.app",
  messagingSenderId: "350865820261",
  appId: "1:350865820261:web:26912e9b753852ae7ed48c"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

const CONFIG = {
  WARD_INFO_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSv7a_sC6S7ytGdHJSEZMHqCPsKhOY-C7hp6K1d-rpUsAUj8LV3Ss3lE89p-IAfEdtFcpOhrOng3LWw/pub?gid=981144620&single=true&output=csv',
  EVENTS_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSv7a_sC6S7ytGdHJSEZMHqCPsKhOY-C7hp6K1d-rpUsAUj8LV3Ss3lE89p-IAfEdtFcpOhrOng3LWw/pub?gid=321660920&single=true&output=csv',
  CORS_PROXY: 'https://api.allorigins.win/raw?url='
};
const state = {
  debugBanner: false,
  bannerSeenKey: 'aspen-ward-banner-seen',
  wardDetails: null,
  lastFocusedElement: null
};
const SELECTORS = {
  brandTitle: document.getElementById('brand-title'),
  brandSubtitle: document.getElementById('brand-subtitle'),
  heroTitle: document.getElementById('hero-heading'),
  heroSubtitle: document.getElementById('hero-subtitle'),
  heroMeta: document.getElementById('hero-meta'),
  programIntro: document.getElementById('program-intro'),
  programGrid: document.getElementById('program-grid'),
  announcementsSection: document.getElementById('announcements'),
  announcementsList: document.getElementById('announcements-list'),
  eventsTimeline: document.getElementById('events-timeline'),
  eventsSection: document.getElementById('events'),
  footerCopy: document.getElementById('footer-copy'),
  navLinks: Array.from(document.querySelectorAll('.nav-link[data-scroll]')),
  modal: document.getElementById('banner-modal'),
  modalTitle: document.getElementById('banner-title'),
  modalBody: document.getElementById('banner-body'),
  modalDismiss: document.getElementById('modal-dismiss'),
  modalClose: document.getElementById('modal-close'),
  themeToggle: document.getElementById('theme-toggle'),
  menuToggle: document.getElementById('menu-toggle'),
  nav: document.getElementById('primary-nav'),
  eventsNavLink: document.querySelector('[data-scroll="events"]'),
  announcementsNavLink: document.querySelector('[data-scroll="announcements"]'),
  newsFlash: document.getElementById('news-flash'),
  newsFlashContent: document.getElementById('news-flash-content'),
  newsFlashClose: document.getElementById('news-flash-close')
};
state.debugBanner = new URLSearchParams(window.location.search).get('banner') === 'debug' || state.debugBanner;
const sanitize = (text = '') => text.replace(/\n/g, '<br>');
function showInlineError(container, message) {
  if (!container) return;
  container.innerHTML = `<p class="error-text">${message}</p>`;
}
async function fetchWithFallback(url) {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Fetch failed: ${response.status} ${response.statusText}`);
    }
    return response;
  } catch (error) {
    console.warn(`Direct fetch failed for ${url}. Retrying with proxy`, error);
    try {
      const proxyResponse = await fetch(`${CONFIG.CORS_PROXY}${encodeURIComponent(url)}`);
      if (!proxyResponse.ok) {
        throw new Error(`Proxy fetch failed: ${proxyResponse.status} ${proxyResponse.statusText}`);
      }
      return proxyResponse;
    } catch (proxyError) {
      console.error(`Unable to retrieve ${url}`, proxyError);
      throw new Error('We were unable to load the latest information. Please try again soon.');
    }
  }
}
function parseCSV(text) {
  if (!text || typeof text !== 'string') {
    throw new Error('Invalid CSV payload');
  }
  if (text.trim().startsWith('<!DOCTYPE html>')) {
    throw new Error('Google Sheet returned HTML instead of CSV. Ensure it is published as CSV.');
  }
  const rows = [];
  let cell = '';
  let row = [];
  let inQuotes = false;
  const commitCell = () => {
    row.push(cell.trim());
    cell = '';
  };
  const commitRow = () => {
    if (row.length && row.some(Boolean)) {
      rows.push(row);
    }
    row = [];
  };
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (char === '"') {
      const next = text[i + 1];
      if (inQuotes && next === '"') {
        cell += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      commitCell();
    } else if (!inQuotes && (char === '\n' || char === '\r')) {
      commitCell();
      commitRow();
      if (char === '\r' && text[i + 1] === '\n') {
        i++;
      }
    } else {
      cell += char;
    }
  }
  if (cell.length || row.length) {
    commitCell();
    commitRow();
  }
  return rows;
}
function formatDateForCalendar(date) {
  const pad = (value) => String(value).padStart(2, '0');
  return [
    date.getUTCFullYear(),
    pad(date.getUTCMonth() + 1),
    pad(date.getUTCDate())
  ].join('') + 'T' + [
    pad(date.getUTCHours()),
    pad(date.getUTCMinutes()),
    pad(date.getUTCSeconds())
  ].join('') + 'Z';
}
function hasDateOrDay(value = '') {
  const text = value.toLowerCase();
  return /(sunday|monday|tuesday|wednesday|thursday|friday|saturday|every\s+\w+)/i.test(text) ||
    /(january|february|march|april|may|june|july|august|september|october|november|december)/i.test(text) ||
    /\d{1,2}(st|nd|rd|th)/i.test(text);
}
function parseEventDate(dateText = '', info = '') {
  const now = new Date();
  const currentYear = now.getFullYear();
  let eventDate = new Date(now);
  const text = `${dateText} ${info}`.trim();
  if (text.toLowerCase().includes('every ')) {
    const day = text.toLowerCase().match(/every\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/);
    if (day) {
      const dayIndex = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'].indexOf(day[1]);
      eventDate = new Date(now);
      while (eventDate.getDay() !== dayIndex) {
        eventDate.setDate(eventDate.getDate() + 1);
      }
    }
  } else {
    const monthMatch = text.match(/(january|february|march|april|may|june|july|august|september|october|november|december)\s+\d{1,2}/i);
    if (monthMatch) {
      eventDate = new Date(`${monthMatch[0]}, ${currentYear}`);
      if (!Number.isFinite(eventDate.valueOf())) {
        eventDate = new Date(now);
      }
      if (eventDate < now) {
        eventDate.setFullYear(currentYear + 1);
      }
    }
  }
  const parseTimeString = (input) => {
    if (!input) return null;
    const match = input.trim().match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
    if (!match) return null;
    let hours = parseInt(match[1], 10);
    const minutes = parseInt(match[2] ?? '0', 10);
    const period = match[3]?.toLowerCase();
    if (period === 'pm' && hours < 12) hours += 12;
    if (period === 'am' && hours === 12) hours = 0;
    if (!period && hours === 24) hours = 0;
    return { hours, minutes };
  };
  const rangeMatch = text.match(/(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s*[-‚Äì]\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)/i);
  let startTime = parseTimeString(rangeMatch ? rangeMatch[1] : text);
  let endTime = rangeMatch ? parseTimeString(rangeMatch[2]) : null;
  if (!startTime) {
    startTime = { hours: 9, minutes: 0 };
  }
  eventDate.setHours(startTime.hours, startTime.minutes, 0, 0);
  const endDate = new Date(eventDate);
  if (endTime) {
    endDate.setHours(endTime.hours, endTime.minutes, 0, 0);
  } else {
    endDate.setHours(endDate.getHours() + 1);
  }
  return { start: eventDate, end: endDate };
}
function createCalendarLink({ title, description, start, end, location }) {
  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: title,
    dates: `${formatDateForCalendar(start)}/${formatDateForCalendar(end)}`,
    details: description
  });
  if (location) params.set('location', location);
  return `https://www.google.com/calendar/render?${params.toString()}`;
}
function getCurrentSunday() {
  const today = new Date();
  const sunday = new Date(today);
  sunday.setDate(today.getDate() - today.getDay());
  return sunday.toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric'
  });
}
function updateNavState(id) {
  SELECTORS.navLinks.forEach((link) => {
    link.classList.toggle('active', link.dataset.scroll === id);
  });
}
function smoothScrollTo(targetId) {
  const element = document.getElementById(targetId);
  if (!element) return;
  element.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function initNavigation() {
  const setMenuState = (isOpen) => {
    if (!SELECTORS.menuToggle || !SELECTORS.nav) return;
    SELECTORS.menuToggle.classList.toggle('open', isOpen);
    SELECTORS.nav.classList.toggle('open', isOpen);
    SELECTORS.menuToggle.setAttribute('aria-expanded', String(isOpen));
  };
  setMenuState(false);
  SELECTORS.navLinks.forEach((link) => {
    link.addEventListener('click', (event) => {
      event.preventDefault();
      const { scroll } = event.currentTarget.dataset;
      updateNavState(scroll);
      smoothScrollTo(scroll);
      setMenuState(false);
    });
  });
  document
    .querySelectorAll('.nav-link:not([data-scroll])')
    .forEach((link) => {
      link.addEventListener('click', () => {
        setMenuState(false);
      });
    });
  [
    ['program-scroll', 'program'],
    ['events-scroll', 'events']
  ].forEach(([id, target]) => {
    const trigger = document.getElementById(id);
    if (trigger) {
      trigger.addEventListener('click', (event) => {
        event.preventDefault();
        updateNavState(target);
        smoothScrollTo(target);
      });
    }
  });
  SELECTORS.menuToggle?.addEventListener('click', () => {
    const isOpen = !SELECTORS.menuToggle.classList.contains('open');
    setMenuState(isOpen);
  });
  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      setMenuState(false);
    }
  });
  const sections = SELECTORS.navLinks
    .map((link) => document.getElementById(link.dataset.scroll))
    .filter(Boolean);
  if (sections.length) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          updateNavState(entry.target.id);
        }
      });
    }, { threshold: 0.55 });
    sections.forEach((section) => observer.observe(section));
  }
}
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.body.dataset.theme = theme;
  if (SELECTORS.themeToggle) {
    const isDark = theme === 'dark';
    const next = isDark ? 'light' : 'dark';
    SELECTORS.themeToggle.setAttribute('aria-label', `Switch to ${next} theme`);
    SELECTORS.themeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
  }
}
function initTheme() {
  const stored = localStorage.getItem('theme');
  const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  const initial = stored === 'light' || stored === 'dark' ? stored : (prefersLight ? 'light' : 'dark');
  applyTheme(initial);
  SELECTORS.themeToggle?.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = current === 'light' ? 'dark' : 'light';
    applyTheme(next);
    localStorage.setItem('theme', next);
  });
}
function initModal() {
  if (SELECTORS.modal) {
    SELECTORS.modal.setAttribute('aria-hidden', 'true');
  }
  const closeModal = () => {
    if (!SELECTORS.modal) return;
    SELECTORS.modal.setAttribute('hidden', '');
    SELECTORS.modal.setAttribute('aria-hidden', 'true');
    document.body.style.removeProperty('overflow');
    if (state.lastFocusedElement instanceof HTMLElement) {
      state.lastFocusedElement.focus();
    }
    state.lastFocusedElement = null;
  };
  const trapFocus = (event) => {
    if (event.key !== 'Tab' || !SELECTORS.modal || SELECTORS.modal.hasAttribute('hidden')) return;
    const focusable = SELECTORS.modal.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (event.shiftKey && document.activeElement === first) {
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  };
  SELECTORS.modalDismiss?.addEventListener('click', closeModal);
  SELECTORS.modalClose?.addEventListener('click', closeModal);
  SELECTORS.modal?.addEventListener('click', (event) => {
    if (event.target === SELECTORS.modal) closeModal();
  });
  SELECTORS.modal?.addEventListener('keydown', trapFocus);
  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') closeModal();
  });
}
function shouldShowBanner() {
  if (state.debugBanner) return true;
  const lastShown = localStorage.getItem(state.bannerSeenKey);
  if (!lastShown) return true;
  const lastDate = new Date(parseInt(lastShown, 10));
  const today = new Date();
  return lastDate.toDateString() !== today.toDateString();
}
function renderBanner({ title, announcements }) {
  if (!SELECTORS.modal || !Array.isArray(announcements) || !announcements.length) return;
  if (!shouldShowBanner()) return;
  SELECTORS.modalTitle.textContent = title || 'Announcements';
  SELECTORS.modalBody.innerHTML = '';
  announcements.forEach((item) => {
    const row = document.createElement('div');
    row.className = 'banner-row';
    if (item.accent) {
      row.style.borderColor = item.accent;
    }
    const heading = document.createElement('div');
    heading.className = 'banner-title';
    heading.textContent = item.title;
    if (item.accent) {
      heading.style.color = item.accent;
    }
    const copy = document.createElement('div');
    copy.innerHTML = item.link
      ? `<a href="${item.link}" target="_blank" rel="noopener">${item.description}</a>`
      : item.description;
    row.append(heading, copy);
    SELECTORS.modalBody.appendChild(row);
  });
  state.lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
  SELECTORS.modal.removeAttribute('hidden');
  SELECTORS.modal.setAttribute('aria-hidden', 'false');
  document.body.style.setProperty('overflow', 'hidden');
  requestAnimationFrame(() => {
    SELECTORS.modalDismiss?.focus();
  });
  if (!state.debugBanner) {
    localStorage.setItem(state.bannerSeenKey, Date.now().toString());
  }
}
function renderNewsFlash({ announcements }) {
  if (!SELECTORS.newsFlash || !SELECTORS.newsFlashContent || !Array.isArray(announcements) || !announcements.length) return;
  if (state.wardDetails?.hideBanner) return;

  SELECTORS.newsFlashContent.innerHTML = '';
  const defaultColors = ['#ffffff', '#f0f0f0', '#e0e0e0', '#d0d0d0'];
  const content = announcements.map((item, index) => {
    const titleText = item.title || 'Announcement';
    const descriptionText = item.description || '';
    const linkText = item.link ? `<a href="${item.link}" target="_blank" rel="noopener">${descriptionText}</a>` : descriptionText;
    const color = item.accent || defaultColors[index % defaultColors.length];
    return `<span style="color: ${color}; padding-right: 3rem;">${titleText}: ${linkText}</span>`;
  }).join(' ‚Ä¢‚Ä¢‚Ä¢ ');
  SELECTORS.newsFlashContent.innerHTML = content;

  SELECTORS.newsFlash.removeAttribute('hidden');
  SELECTORS.newsFlash.setAttribute('aria-hidden', 'false');

  const contentWidth = SELECTORS.newsFlashContent.offsetWidth;
  const windowWidth = window.innerWidth;
  const scrollDuration = Math.max(10, (contentWidth / windowWidth) * 15);
  SELECTORS.newsFlashContent.style.animationDuration = `${scrollDuration}s`;

  const autoDismiss = setTimeout(() => {
    closeNewsFlash();
  }, scrollDuration * 1000);

  SELECTORS.newsFlashClose?.addEventListener('click', () => {
    clearTimeout(autoDismiss);
    closeNewsFlash();
  }, { once: true });

  function closeNewsFlash() {
    SELECTORS.newsFlash.setAttribute('hidden', '');
    SELECTORS.newsFlash.setAttribute('aria-hidden', 'true');
  }
}
function updateWardDom({
  wardName,
  subtitle,
  location,
  sacramentStart,
  hideEvents,
  hideBanner
}) {
  document.title = `${wardName} ‚Äì ${subtitle}`;
  if (SELECTORS.brandTitle) SELECTORS.brandTitle.textContent = wardName;
  if (SELECTORS.brandSubtitle) SELECTORS.brandSubtitle.textContent = subtitle;
  if (SELECTORS.heroTitle) SELECTORS.heroTitle.textContent = `${wardName} Sunday Services`;
  if (SELECTORS.heroSubtitle) {
    SELECTORS.heroSubtitle.textContent = `${subtitle} ¬∑ .`;
  }
  if (SELECTORS.heroMeta) {
    SELECTORS.heroMeta.textContent = `üóìÔ∏è ${getCurrentSunday()} ‚õ™ ${location} ‚è∞ ${sacramentStart}`;
  }
  if (SELECTORS.programIntro) {
    SELECTORS.programIntro.textContent = "A quick look";
  }
  if (SELECTORS.footerCopy) {
    SELECTORS.footerCopy.textContent = `‚ùñ Not an official site of The Church of Jesus Christ of Latter-day Saints. Intended for local ${wardName} use only.`;
  }
  if (hideEvents) {
    SELECTORS.eventsSection?.setAttribute('hidden', '');
    SELECTORS.eventsNavLink?.setAttribute('hidden', '');
  } else {
    SELECTORS.eventsSection?.removeAttribute('hidden');
    SELECTORS.eventsNavLink?.removeAttribute('hidden');
  }
  if (hideBanner && SELECTORS.modal) {
    SELECTORS.modal.setAttribute('hidden', '');
    SELECTORS.modal.setAttribute('aria-hidden', 'true');
  }
  return { wardName, subtitle, location, sacramentStart, hideBanner };
}
async function loadWardInfo() {
  try {
    const response = await fetchWithFallback(CONFIG.WARD_INFO_URL);
    const rows = parseCSV(await response.text());
    if (!rows.length) {
      throw new Error('Ward info sheet is empty');
    }
    const wardInfo = {};
    rows.forEach((row) => {
      for (let i = 0; i < row.length; i++) {
        const key = row[i]?.trim().toLowerCase();
        if (!key) continue;
        const value = row[i + 1]?.trim();
        if (value) {
          wardInfo[key] = value;
        }
      }
    });
    const details = {
      wardName: wardInfo['ward name'] ?? 'Aspen Ward',
      subtitle: wardInfo['subtitle'] ?? '',
      location: wardInfo['location'] ?? 'Fruita, Colorado',
      sacramentStart: wardInfo['sacrament start time'] ?? '9:00 AM',
      hideEvents: wardInfo['events']?.toUpperCase() === 'YES',
      hideBanner: wardInfo['pop up banner']?.toUpperCase() === 'YES'
    };
    state.wardDetails = updateWardDom(details);
    return state.wardDetails;
  } catch (error) {
    console.error('Ward info failed to load', error);
    const fallback = {
      wardName: 'Aspen Ward',
      subtitle: 'Sunday Worship Service',
      location: 'Fruita, Colorado',
      sacramentStart: '9:00 AM',
      hideEvents: false,
      hideBanner: false
    };
    state.wardDetails = updateWardDom(fallback);
    return state.wardDetails;
  }
}
function renderAnnouncements(items = []) {
  const { announcementsSection, announcementsList, announcementsNavLink } = SELECTORS;
  if (!announcementsSection || !announcementsList) return;
  announcementsList.innerHTML = '';
  if (!items || !items.length) {
    announcementsSection.setAttribute('hidden', '');
    announcementsSection.setAttribute('aria-hidden', 'true');
    announcementsNavLink?.setAttribute('hidden', '');
    return;
  }
  announcementsSection.removeAttribute('hidden');
  announcementsSection.setAttribute('aria-hidden', 'false');
  announcementsNavLink?.removeAttribute('hidden');
  items.forEach((item, index) => {
    const card = document.createElement('article');
    card.className = 'announcement-card';
    card.setAttribute('role', 'listitem');
    card.style.animationDelay = `${index * 70}ms`;
    if (item.accent) {
      card.style.setProperty('--announcement-accent', item.accent);
    } else {
      card.style.removeProperty('--announcement-accent');
    }
    const title = document.createElement('h3');
    title.className = 'announcement-title';
    title.textContent = item.title || 'Announcement';
    card.appendChild(title);
    if (item.description) {
      const body = document.createElement('p');
      body.className = 'announcement-body';
      body.innerHTML = sanitize(item.description);
      card.appendChild(body);
    }
    if (item.link && item.link.startsWith('http')) {
      const link = document.createElement('a');
      link.className = 'announcement-link';
      link.href = item.link;
      link.target = '_blank';
      link.rel = 'noopener';
      link.setAttribute('aria-label', `Open details for ${item.title || 'announcement'}`);
      link.innerHTML = 'Open details <span aria-hidden="true">‚Üó</span>';
      card.appendChild(link);
    }
    announcementsList.appendChild(card);
  });
}
function renderProgram(rows) {
  if (!SELECTORS.programGrid) return;
  SELECTORS.programGrid.innerHTML = '';
  const cards = [];
  let bannerTitle = 'Announcements';
  const bannerItems = [];
  const announcementItems = [];
  for (let i = 0; i < rows.length; i++) {
    const [program = '', details = '', link = '', accent = ''] = rows[i];
    if (!program.trim()) continue;
    if (program.startsWith('#SECTION:')) {
      const sectionName = program.replace('#SECTION:', '').trim().toLowerCase();
      if (sectionName === 'banner') {
        bannerTitle = details || bannerTitle;
        let j = i + 1;
        while (rows[j] && !rows[j][0]?.startsWith('#SECTION:')) {
          const [title, description, url, color] = rows[j];
          bannerItems.push({
            title: (title || 'Announcement').trim(),
            description: (description || '').trim(),
            link: (url || '').trim(),
            accent: (color || accent || '').trim()
          });
          j++;
        }
        i = j - 1;
      } else if (sectionName === 'announcements') {
        let j = i + 1;
        while (rows[j] && !rows[j][0]?.startsWith('#SECTION:')) {
          const [title, description, url, color] = rows[j];
          const rawTitle = (title || '').trim();
          const trimmedDescription = (description || '').trim();
          const trimmedLink = (url || '').trim();
          const trimmedAccent = (color || accent || '').trim();
          if (!rawTitle && !trimmedDescription && !trimmedLink) {
            j++;
            continue;
          }
          announcementItems.push({
            title: rawTitle || 'Announcement',
            description: trimmedDescription,
            link: trimmedLink,
            accent: trimmedAccent
          });
          j++;
        }
        i = j - 1;
      }
      continue;
    }
    const card = document.createElement('article');
    card.className = 'program-card';
    card.setAttribute('role', 'listitem');
    const heading = document.createElement('p');
    heading.className = 'program-title';
    heading.textContent = program.trim();
    const description = document.createElement('p');
    description.className = 'program-detail';
    const trimmedLink = link.trim();
    const html = trimmedLink.startsWith('http') ? `<a href="${trimmedLink}" target="_blank" rel="noopener">${sanitize(details)}</a>` : sanitize(details);
    description.innerHTML = html;
    card.append(heading, description);
    cards.push(card);
  }
  if (!cards.length) {
    const empty = document.createElement('p');
    empty.className = 'error-text';
    empty.textContent = 'Program information will be available shortly.';
    SELECTORS.programGrid.appendChild(empty);
  } else {
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 70}ms`;
      SELECTORS.programGrid.appendChild(card);
    });
  }
  renderAnnouncements(announcementItems);
  if (!state.wardDetails?.hideBanner && bannerItems.length) {
    renderBanner({ title: bannerTitle, announcements: bannerItems });
    renderNewsFlash({ announcements: bannerItems });
  }
}
async function loadProgram() {
  try {
    const snapshot = await get(ref(db, 'sundayProgram'));
    const data = snapshot.val();

    if (!data) {
      throw new Error('Program data is empty');
    }

    let rows = [];

    // Handle new structured format (from updated admin page)
    if (data.sections) {
      // Set introduction if available
      if (data.introduction && SELECTORS.programIntro) {
        SELECTORS.programIntro.textContent = data.introduction;
      }

      // Convert structured sections to rows format for renderProgram
      const sectionOrder = ['banner', 'opening', 'sacrament', 'speakers', 'closing', 'announcements'];
      const sectionLabels = {
        banner: 'Banner',
        opening: 'Opening',
        sacrament: 'Sacrament',
        speakers: 'Speakers',
        closing: 'Closing',
        announcements: 'Announcements'
      };

      // Handle testimony meeting
      if (data.isTestimonyMeeting) {
        // Replace speakers section with testimony message
        sectionOrder.splice(sectionOrder.indexOf('speakers'), 1);
      }

      sectionOrder.forEach(sectionKey => {
        const items = data.sections?.[sectionKey] || [];
        if (items.length > 0) {
          // Add section header
          rows.push([`#SECTION: ${sectionLabels[sectionKey]}`, '', '', '']);

          // Add items
          items.forEach(item => {
            rows.push([
              item.label || '',
              item.details || '',
              item.link || '',
              item.accent || ''
            ]);
          });
        }
      });

      // If testimony meeting, add testimony message as a special item
      if (data.isTestimonyMeeting && data.testimonyMessage) {
        // Find where to insert testimony message (after sacrament section)
        let sacramentIndex = -1;
        let insertIndex = -1;
        for (let i = 0; i < rows.length; i++) {
          if (rows[i][0] === '#SECTION: Sacrament') {
            sacramentIndex = i;
          } else if (sacramentIndex !== -1 && rows[i][0].startsWith('#SECTION:')) {
            insertIndex = i;
            break;
          }
        }
        if (insertIndex !== -1) {
          rows.splice(insertIndex, 0, ['Testimony Meeting', data.testimonyMessage, '', '']);
        } else if (sacramentIndex !== -1) {
          // If no section after sacrament, add at the end
          rows.push(['Testimony Meeting', data.testimonyMessage, '', '']);
        }
      }
    }
    // Handle legacy array format
    else if (Array.isArray(data)) {
      rows = data.map(row => [
        row.program || '',
        row.details || '',
        row.link || '',
        row.accent || ''
      ]);
    }

    if (!rows.length) {
      throw new Error('No program data available');
    }

    renderProgram(rows);
  } catch (error) {
    console.error('Program failed to load', error);
    showInlineError(SELECTORS.programGrid, 'We could not load the program. Please refresh or try again soon.');
    renderAnnouncements([]);
  }
}
function renderEvents(rows) {
  if (!SELECTORS.eventsTimeline) return;
  SELECTORS.eventsTimeline.innerHTML = '';
  if (!rows.length) {
    showInlineError(SELECTORS.eventsTimeline, 'No upcoming events were found. Check back soon!');
    return;
  }
  rows.forEach(([dateRaw = '', titleRaw = '', infoRaw = '', iconRaw = '', urlRaw = '']) => {
    const info = infoRaw.trim();
    if (!info) return;
    const date = dateRaw.trim();
    const title = titleRaw.trim();
    const icon = iconRaw.trim();
    const link = urlRaw.trim();
    const card = document.createElement('article');
    card.className = 'event-card';
    const header = document.createElement('div');
    header.className = 'event-header';
    const dateLabel = document.createElement('span');
    dateLabel.className = 'event-date';
    dateLabel.textContent = date || 'Date TBD';
    const name = document.createElement('h3');
    name.className = 'event-title';
    name.textContent = `${icon || 'üìÖ'} ${title || 'Ward Event'}`;
    header.append(dateLabel, name);
    const body = document.createElement('div');
    body.className = 'event-body';
    body.innerHTML = link.startsWith('http')
      ? `<a href="${link}" target="_blank" rel="noopener">${info}</a>`
      : info;
    card.append(header, body);
    if (hasDateOrDay(date) || hasDateOrDay(info)) {
      const { start, end } = parseEventDate(date, infoRaw);
      const calendarLink = document.createElement('a');
      calendarLink.href = createCalendarLink({
        title: title || 'Ward Event',
        description: info,
        start,
        end,
        location: state.wardDetails?.location
      });
      calendarLink.target = '_blank';
      calendarLink.rel = 'noopener';
      calendarLink.className = 'calendar-link';
      calendarLink.textContent = 'Add to calendar';
      card.appendChild(calendarLink);
    }
    SELECTORS.eventsTimeline.appendChild(card);
  });
}
async function loadEvents() {
  if (SELECTORS.eventsSection?.hasAttribute('hidden')) return;
  try {
    // Try Firebase first (new admin page stores events here)
    const snapshot = await get(ref(db, 'events'));
    const data = snapshot.val();

    if (data && Array.isArray(data) && data.length > 0) {
      // Convert Firebase format to rows format expected by renderEvents
      // Firebase stores: [{type, date, title, info, link}, ...]
      // renderEvents expects: [[date, title, info, link], ...]
      const rows = data.map(event => [
        event.date || '',
        event.title || '',
        event.info || '',
        event.link || ''
      ]);
      renderEvents(rows);
    } else {
      // Fallback to Google Sheets if no Firebase data
      const response = await fetchWithFallback(CONFIG.EVENTS_URL);
      const rows = parseCSV(await response.text());
      if (rows[0]?.[0]?.toLowerCase().includes('date')) {
        rows.shift();
      }
      renderEvents(rows);
    }
  } catch (error) {
    console.error('Events failed to load', error);
    showInlineError(SELECTORS.eventsTimeline, 'Upcoming events are unavailable right now.');
  }
}
async function init() {
  initTheme();
  initNavigation();
  initModal();
  await loadWardInfo();
  const results = await Promise.allSettled([
    loadProgram(),
    loadEvents()
  ]);
  results.forEach((result) => {
    if (result.status === 'rejected') {
      console.error(result.reason);
    }
  });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>