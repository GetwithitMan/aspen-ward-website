<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aspen Ward – Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/dist/output.css">
<style>
.admin-content {
  max-width: 700px;
  margin: 0 auto;
  padding: 2rem 1rem 6rem;
}

.login-card {
  max-width: 360px;
  margin: 4rem auto;
  padding: 2rem;
  background: var(--surface);
  border: 1px solid var(--stroke);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
}

.login-card h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  margin: 0 0 1.5rem;
  text-align: center;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.form-group input {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1px solid var(--stroke);
  border-radius: var(--radius-sm);
  font: inherit;
  background: var(--surface);
  color: var(--ink);
}

.form-group input:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.error-message {
  color: var(--warning);
  font-size: 0.9rem;
  margin-top: 0.5rem;
  display: none;
}

.error-message.visible {
  display: block;
}

/* Editor */
.editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.editor-header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.6rem;
  margin: 0;
}

/* Section cards */
.section-card {
  background: var(--surface);
  border: 1px solid var(--stroke);
  border-radius: var(--radius-md);
  margin-bottom: 1.5rem;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.section-header {
  background: linear-gradient(135deg, var(--accent), var(--accent-strong));
  color: white;
  padding: 0.75rem 1rem;
  font-weight: 600;
  font-size: 0.95rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-header button {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: 500;
}

.section-header button:hover {
  background: rgba(255,255,255,0.3);
}

.section-body {
  padding: 0.5rem;
}

/* Row items */
.row-item {
  display: grid;
  grid-template-columns: 1fr 2fr auto;
  gap: 0.5rem;
  padding: 0.5rem;
  border-bottom: 1px solid var(--stroke);
  align-items: start;
}

.row-item:last-child {
  border-bottom: none;
}

.row-item input,
.row-item textarea {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--stroke);
  border-radius: 8px;
  font: inherit;
  font-size: 0.9rem;
  background: var(--surface);
  color: var(--ink);
}

.row-item input:focus,
.row-item textarea:focus {
  outline: 2px solid var(--accent);
  outline-offset: 1px;
}

.row-item textarea {
  resize: vertical;
  min-height: 60px;
}

.row-item .field-label {
  font-size: 0.75rem;
  color: var(--ink-muted);
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.row-item .field-group {
  display: flex;
  flex-direction: column;
}

.btn-delete-row {
  background: none;
  border: none;
  color: var(--warning);
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 6px;
  opacity: 0.6;
  transition: opacity 0.2s;
  align-self: center;
}

.btn-delete-row:hover {
  opacity: 1;
  background: rgba(217, 119, 6, 0.1);
}

/* Link toggle */
.link-toggle {
  font-size: 0.8rem;
  color: var(--accent);
  cursor: pointer;
  margin-top: 0.25rem;
}

.link-toggle:hover {
  text-decoration: underline;
}

.link-input {
  margin-top: 0.5rem;
}

.link-input.hidden {
  display: none;
}

/* Status bar */
.status-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 1rem;
  background: var(--surface);
  border-top: 1px solid var(--stroke);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  z-index: 50;
}

.status-text {
  font-size: 0.9rem;
  color: var(--ink-soft);
}

.status-text.saving { color: var(--accent); }
.status-text.saved { color: #22c55e; }
.status-text.error { color: var(--warning); }

/* Empty section */
.empty-section {
  padding: 1.5rem;
  text-align: center;
  color: var(--ink-muted);
  font-style: italic;
}

@media (max-width: 600px) {
  .row-item {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .btn-delete-row {
    justify-self: end;
  }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
  <div class="login-card">
    <h1>Admin Login</h1>
    <form id="login-form">
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required autocomplete="current-password">
        <p class="error-message" id="login-error">Invalid password</p>
      </div>
      <button type="submit" class="btn full">Sign In</button>
    </form>
  </div>
</div>

<!-- Editor Screen -->
<div id="editor-screen" hidden>
  <header class="site-header">
    <div class="header-shell">
      <a class="brand" href="/">
        <span class="brand-icon">AW</span>
        <span class="brand-copy">
          <span class="brand-title">Aspen Ward</span>
          <span class="brand-subtitle">Program Editor</span>
        </span>
      </a>
      <div class="header-actions">
        <button class="btn ghost" id="logout-btn">Logout</button>
      </div>
    </div>
  </header>

  <main class="admin-content">
    <div class="editor-header">
      <h1>Sunday Program</h1>
      <button class="btn" id="save-btn">Save Changes</button>
    </div>

    <div id="sections-container">
      <!-- Sections rendered by JS -->
    </div>
  </main>

  <div class="status-bar">
    <span class="status-text" id="status-text">Ready</span>
    <button class="btn" id="save-btn-bottom">Save Changes</button>
  </div>
</div>

<script type="module">
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwYlUNAg2BLeAzGaZF6WkKHYHbRsJLzTUvCY4-IA-pB61VNpaZRxe5wV5Ic9Uukh3I7/exec';

// State
let programData = [];
let hasUnsavedChanges = false;
let sessionPassword = '';

// DOM Elements
const loginScreen = document.getElementById('login-screen');
const editorScreen = document.getElementById('editor-screen');
const loginForm = document.getElementById('login-form');
const loginError = document.getElementById('login-error');
const sectionsContainer = document.getElementById('sections-container');
const statusText = document.getElementById('status-text');
const saveBtn = document.getElementById('save-btn');
const saveBtnBottom = document.getElementById('save-btn-bottom');
const logoutBtn = document.getElementById('logout-btn');

// Section display names
const SECTION_NAMES = {
  'banner': 'Banner / Welcome',
  'introduction': 'Introduction',
  'opening': 'Opening',
  'sacrament': 'Sacrament',
  'speakers': 'Speakers',
  'closing': 'Closing',
  'announcements': 'Announcements'
};

// Check for saved session
const savedPassword = sessionStorage.getItem('adminPassword');
if (savedPassword) {
  sessionPassword = savedPassword;
  showEditor();
}

// Login
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const password = document.getElementById('password').value;
  setStatus('Logging in...', 'saving');

  try {
    const response = await callApi('login', { password });
    if (response.success) {
      sessionPassword = password;
      sessionStorage.setItem('adminPassword', password);
      loginError.classList.remove('visible');
      showEditor();
    } else {
      loginError.classList.add('visible');
      setStatus('Login failed', 'error');
    }
  } catch (error) {
    loginError.textContent = 'Connection error';
    loginError.classList.add('visible');
    setStatus('Connection error', 'error');
  }
});

// Logout
logoutBtn.addEventListener('click', () => {
  if (hasUnsavedChanges && !confirm('You have unsaved changes. Logout anyway?')) return;
  sessionPassword = '';
  sessionStorage.removeItem('adminPassword');
  loginScreen.hidden = false;
  editorScreen.hidden = true;
});

async function showEditor() {
  loginScreen.hidden = true;
  editorScreen.hidden = false;
  await loadProgram();
}

// Load data
async function loadProgram() {
  setStatus('Loading...', 'saving');

  try {
    const response = await callApi('read', { password: sessionPassword });

    if (response.success) {
      programData = response.data;
      renderSections();
      setStatus('Loaded successfully', 'saved');
    } else {
      setStatus('Error: ' + response.error, 'error');
      if (response.error.includes('password')) {
        sessionStorage.removeItem('adminPassword');
        loginScreen.hidden = false;
        editorScreen.hidden = true;
      }
    }
  } catch (error) {
    setStatus('Connection error', 'error');
  }
}

// Parse data into sections
function parseIntoSections() {
  const sections = [];
  let currentSection = null;

  programData.forEach((row, index) => {
    const program = (row.program || '').trim();

    if (program.toLowerCase().startsWith('#section:')) {
      // Start new section
      const sectionKey = program.replace(/#section:\s*/i, '').toLowerCase().trim();
      currentSection = {
        key: sectionKey,
        name: SECTION_NAMES[sectionKey] || sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1),
        headerIndex: index,
        headerDetails: row.details || '',
        rows: []
      };
      sections.push(currentSection);
    } else if (currentSection && program) {
      // Add row to current section
      currentSection.rows.push({
        dataIndex: index,
        program: program,
        details: row.details || '',
        link: row.link || ''
      });
    }
  });

  return sections;
}

// Render sections
function renderSections() {
  const sections = parseIntoSections();
  sectionsContainer.innerHTML = '';

  sections.forEach(section => {
    const card = document.createElement('div');
    card.className = 'section-card';
    card.dataset.sectionKey = section.key;

    card.innerHTML = `
      <div class="section-header">
        <span>${section.name}</span>
        <button onclick="addRowToSection('${section.key}')">+ Add</button>
      </div>
      <div class="section-body" id="section-${section.key}">
        ${section.rows.length === 0
          ? '<div class="empty-section">No items yet</div>'
          : section.rows.map(row => renderRowItem(row)).join('')
        }
      </div>
    `;

    sectionsContainer.appendChild(card);
  });

  // Add event listeners
  document.querySelectorAll('.row-item input, .row-item textarea').forEach(el => {
    el.addEventListener('input', handleInputChange);
  });
}

function renderRowItem(row) {
  const hasLink = row.link && row.link.trim();
  return `
    <div class="row-item" data-index="${row.dataIndex}">
      <div class="field-group">
        <span class="field-label">Label</span>
        <input type="text" value="${escapeHtml(row.program)}" data-field="program" placeholder="e.g., Speaker">
      </div>
      <div class="field-group">
        <span class="field-label">Details</span>
        <textarea data-field="details" placeholder="e.g., John Smith">${escapeHtml(row.details)}</textarea>
        <span class="link-toggle" onclick="toggleLink(this)">${hasLink ? '− Hide link' : '+ Add link'}</span>
        <input type="text" class="link-input ${hasLink ? '' : 'hidden'}" value="${escapeHtml(row.link)}" data-field="link" placeholder="https://...">
      </div>
      <button class="btn-delete-row" onclick="deleteRow(${row.dataIndex})" title="Delete">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    </div>
  `;
}

// Handle input changes
function handleInputChange(e) {
  const rowEl = e.target.closest('.row-item');
  const index = parseInt(rowEl.dataset.index);
  const field = e.target.dataset.field;

  if (programData[index]) {
    programData[index][field] = e.target.value;
    markUnsaved();
  }
}

// Toggle link visibility
window.toggleLink = function(el) {
  const linkInput = el.nextElementSibling;
  const isHidden = linkInput.classList.contains('hidden');

  if (isHidden) {
    linkInput.classList.remove('hidden');
    el.textContent = '− Hide link';
  } else {
    linkInput.classList.add('hidden');
    linkInput.value = '';
    // Update data
    const rowEl = el.closest('.row-item');
    const index = parseInt(rowEl.dataset.index);
    if (programData[index]) {
      programData[index].link = '';
      markUnsaved();
    }
    el.textContent = '+ Add link';
  }
};

// Add row to section
window.addRowToSection = function(sectionKey) {
  // Find the section header and last row of that section
  let insertIndex = -1;
  let inSection = false;

  for (let i = 0; i < programData.length; i++) {
    const program = (programData[i].program || '').trim().toLowerCase();

    if (program === `#section: ${sectionKey}` || program === `#section:${sectionKey}`) {
      inSection = true;
      insertIndex = i + 1;
    } else if (inSection && program.startsWith('#section:')) {
      // Hit next section, insert before it
      break;
    } else if (inSection) {
      insertIndex = i + 1;
    }
  }

  if (insertIndex === -1) {
    insertIndex = programData.length;
  }

  // Insert new row
  const newRow = {
    rowIndex: insertIndex,
    program: '',
    details: '',
    link: ''
  };

  programData.splice(insertIndex, 0, newRow);

  // Re-index all rows
  programData.forEach((row, i) => row.rowIndex = i);

  renderSections();
  markUnsaved();

  // Focus the new input
  const sectionBody = document.getElementById(`section-${sectionKey}`);
  if (sectionBody) {
    const inputs = sectionBody.querySelectorAll('input[data-field="program"]');
    const lastInput = inputs[inputs.length - 1];
    if (lastInput) lastInput.focus();
  }
};

// Delete row
window.deleteRow = function(index) {
  if (!confirm('Delete this row?')) return;

  programData.splice(index, 1);
  programData.forEach((row, i) => row.rowIndex = i);

  renderSections();
  markUnsaved();
};

// Save
async function saveChanges() {
  setStatus('Saving...', 'saving');
  saveBtn.disabled = true;
  saveBtnBottom.disabled = true;

  try {
    const response = await callApi('save', {
      password: sessionPassword,
      data: JSON.stringify(programData)
    });

    if (response.success) {
      hasUnsavedChanges = false;
      setStatus('Saved!', 'saved');
    } else {
      setStatus('Error: ' + response.error, 'error');
    }
  } catch (error) {
    setStatus('Connection error', 'error');
  }

  saveBtn.disabled = false;
  saveBtnBottom.disabled = false;
}

saveBtn.addEventListener('click', saveChanges);
saveBtnBottom.addEventListener('click', saveChanges);

function markUnsaved() {
  hasUnsavedChanges = true;
  setStatus('Unsaved changes', '');
}

function setStatus(text, state) {
  statusText.textContent = text;
  statusText.className = 'status-text' + (state ? ' ' + state : '');
}

async function callApi(action, params = {}) {
  // Use POST with form data for better compatibility with Google Apps Script
  const formData = new FormData();
  formData.append('action', action);
  for (const [key, value] of Object.entries(params)) {
    formData.append(key, value);
  }

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    return response.json();
  } catch (err) {
    // Fallback to GET for simple requests (login, read)
    if (action === 'login' || action === 'read') {
      const url = new URL(SCRIPT_URL);
      url.searchParams.set('action', action);
      for (const [key, value] of Object.entries(params)) {
        url.searchParams.set(key, value);
      }
      const response = await fetch(url.toString());
      return response.json();
    }
    throw err;
  }
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = '';
  }
});
</script>
</body>
</html>
